# 检测标准管理系统数据模型说明

## 模型概述

本项目采用SQLAlchemy ORM框架实现数据模型，主要分为**检测相关模型**、**用户相关模型**和**图片相关模型**三大模块，分别位于`app/models/detection/`、`app/models/user/`和`app/models/image/`子目录中。

### 模型分类

1. **检测相关模型**（6个核心模型）：
   - `Category` - 分类表，用于管理检测对象的分类结构
   - `DetectionObject` - 检测对象表，代表具体的检测对象（如材料类型）
   - `DetectionStandard` - 检测规范表，管理检测标准规范
   - `DetectionItem` - 检测项目表，核心关联表，连接检测对象和检测参数
   - `DetectionParam` - 检测参数表，包含检测指南相关字段
   - `DelegationFormTemplate` - 委托单模板表，管理委托单模板

2. **用户相关模型**（6个核心模型）：
   - `User` - 用户表，管理系统用户
   - `Role` - 角色表，管理用户角色
   - `Permission` - 权限表，管理系统权限
   - `Resource` - 资源表，管理系统资源
   - `Action` - 动作表，管理操作动作
   - `Scope` - 范围表，管理权限范围

3. **图片相关模型**（1个核心模型）：
   - `DataImage` - 图片表，用于管理系统中的图片数据

4. **多对多中间表**：
   - `DetectionParamStandard` - 检测参数与检测规范的多对多关系表
   - 用户模块的多对多中间表（`user_roles`, `role_permissions`等）

## 表关系图

```
+-------------------+      +------------------------+
|   Category        |      | DetectionStandard      |
+-------------------+      +------------------------+
| - category_id     |      | - standard_id          |
| - category_name   |      | - standard_code        |
| - parent_id       |      | - standard_name        |
| - ...             |      | - ...                  |
+-------------------+      +------------------------+
        |                           |
        | 1:N                       |
        v                           |
+------------------------+          |
| DetectionObject       |          |
+------------------------+          |
| - object_id           |          |
| - object_name         |          |
| - category_id         |          |
| - ...                 |          |
+------------------------+          |
        |                           |
        | 1:N                       |
        v                           |
+------------------------+          |
| DetectionItem         |          |
+------------------------+          |
| - item_id             |          |
| - object_id           |          |
| - item_name           |          |
| - ...                 |          |
+------------------------+          |
        |                           |
        | 1:N                       |
        v                           |
+------------------------+      +------------------------+
| DetectionParam        |      | DetectionParamStandard |
+------------------------+      +------------------------+
| - param_id            |---->| - param_id             |
| - item_id             |      | - standard_id          |
| - param_name          |      | - is_main              |
| - template_id         |<----| - ...                  |
| - sample_image_path   |---->|                        |
| - ...                 |
+------------------------+      +------------------------+
        |                           |
        | M:1                       |
        v                           |
+------------------------+          |
| DelegationFormTemplate |          |
+------------------------+          |
| - template_id          |          |
| - template_name        |          |
| - ...                  |          |
+------------------------+          |
                                    |
+------------------------+          |
|      DataImage         |          |
+------------------------+          |
| - image_id             |          |
| - data_unique_id       |          |
| - image_path           |          |
| - image_type           |          |
| - device_type          |          |
| - ...                  |          |
+------------------------+          |
```

## 详细关系说明

### 1. 分类表 (Category)
- **功能**：管理检测对象的分类结构，支持多级分类
- **与检测对象的关系**：一对多关系，一个分类可以包含多个检测对象
- **自引用关系**：通过`parent_id`实现树形结构，支持父子分类
- **唯一约束**：同一父分类下分类名称唯一

### 2. 检测对象表 (DetectionObject)
- **功能**：代表具体的检测对象（如材料类型），位于分类和检测项目之间
- **与分类的关系**：多对一关系，一个检测对象属于一个分类
- **与检测项目的关系**：一对多关系，一个检测对象可以包含多个检测项目
- **核心字段**：包含排序号（sort_order）属性，用于控制检测对象的显示顺序
- **唯一约束**：同一分类下检测对象名称唯一

### 3. 检测项目表 (DetectionItem)
- **功能**：核心关联表，连接检测对象和具体检测参数，用于管理相关检测参数的分组
- **与检测对象的关系**：多对一关系，一个检测项目属于一个检测对象
- **与检测参数的关系**：一对多关系，一个检测项目包含多个检测参数
- **唯一约束**：同一检测对象下项目名称唯一

### 4. 检测参数表 (DetectionParam)
- **功能**：管理单个检测参数的详细信息，包含检测指南相关字段
- **与检测项目的关系**：多对一关系，一个检测参数属于一个检测项目
- **与检测规范的关系**：多对多关系，通过`DetectionParamStandard`中间表实现
- **与委托单模板的关系**：多对一关系，通过`template_id`外键直接关联
- **检测指南字段**：包含取样规则、检测要求、报告时间等检测指南信息
- **唯一约束**：同一项目和材料下参数名称唯一

### 5. 检测规范表 (DetectionStandard)
- **功能**：管理检测标准规范，如国家标准、行业标准等
- **与检测参数的关系**：多对多关系，一个检测规范可以被多个检测参数使用
- **自引用关系**：通过`replace_id`实现规范的替代关系
- **唯一约束**：规范编号唯一

### 6. 委托单模板表 (DelegationFormTemplate)
- **功能**：管理委托单模板，提供多种模板供用户下载
- **与检测参数的关系**：一对多关系，一个委托单模板可以被多个检测参数使用
- **动态文件路径**：通过`@property`动态生成文件路径

### 7. 多对多中间表
- **DetectionParamStandard**：检测参数与检测规范的关联关系，包含是否主规范等额外信息
- **用户模块中间表**：管理用户-角色、角色-权限等多对多关系

### 8. 图片表 (DataImage)
- **功能**：用于管理系统中的图片数据，支持不同设备类型和图片类型
- **核心字段**：包含图片ID、数据唯一标识、图片路径、图片类型、设备类型等
- **图片类型**：支持PNG和SVG两种格式
- **设备类型**：支持PC、手机和平板三种设备类型
- **唯一约束**：数据唯一标识、设备类型和图片类型的组合唯一
- **动态属性**：支持通过@property装饰器实现动态生成属性值

## 数据流向

1. 分类数据首先被创建，用于组织检测对象
2. 检测对象基于分类创建，代表具体的检测对象（如材料类型）
3. 检测项目基于检测对象创建，代表一组相关的检测参数
4. 检测规范被定义，用于指导检测过程
5. 在检测项目下添加具体的检测参数，同时包含检测指南相关属性
6. 检测参数关联相关的检测规范和委托单模板
7. 为检测项目添加委托单模板，供客户下载填写

## 模型文件列表

### 核心模型文件

#### 检测相关模型 (`app/models/detection/`)
- `__init__.py` - 检测相关模型初始化文件
- `category.py` - 分类模型
- `detection_object.py` - 检测对象模型
- `detection_standard.py` - 检测规范模型
- `detection_item.py` - 检测项目模型
- `detection_param.py` - 检测参数模型（包含检测指南字段）
- `delegation_form_template.py` - 委托单模板模型

#### 用户相关模型 (`app/models/user/`)
- `__init__.py` - 用户相关模型初始化文件
- `user.py` - 用户模型
- `role.py` - 角色模型
- `permission.py` - 权限模型
- `resource.py` - 资源模型
- `action.py` - 动作模型
- `scope.py` - 范围模型

#### 图片相关模型 (`app/models/image/`)
- `data_image.py` - 图片模型，用于管理系统中的图片数据

#### 多对多中间表 (`app/models/`)
- `associations.py` - 统一管理所有多对多中间表
  - `DetectionParamStandard` - 检测参数与检测规范的多对多关系表
  - 用户模块的多对多中间表（`user_roles`, `role_permissions`等）

### 模型初始化文件

- `app/models/__init__.py` - 全局模型初始化文件，导入并暴露所有模型类

## 技术实现

- **ORM框架**：SQLAlchemy
- **数据库支持**：支持MySQL、SQLite等多种数据库
- **关系映射**：通过ORM实现对象与数据库表的映射
- **事务支持**：支持数据库事务管理
- **模型扩展**：支持通过继承Base类扩展新模型
- **动态属性**：支持通过@property装饰器实现动态生成属性值

## 核心功能

1. **分类管理**：支持多级分类结构，便于组织检测对象
2. **检测对象管理**：管理具体的检测对象信息
3. **检测项目管理**：核心关联表，连接检测对象和检测参数
4. **检测参数管理**：包含检测指南相关字段，管理具体的检测参数信息
5. **检测规范管理**：支持多规范关联，一个检测参数可以遵循多个标准规范
6. **委托单模板管理**：提供多种委托单模板，满足不同检测项目需求
7. **用户权限管理**：基于RBAC（角色-权限-资源）模型实现权限控制

## 模型初始化

所有模型通过`__init__.py`文件统一导入和导出，便于在其他模块中使用：

```python
# 全局模型导出 (app/models/__init__.py)
from .user.user import User
from .detection import Category, DetectionObject, DetectionStandard, DetectionItem, DetectionParam, DelegationFormTemplate
from .image.data_image import DataImage
from .associations import DetectionParamStandard

__all__ = ['User', 'Category', 'DetectionObject', 'DetectionStandard', 'DetectionItem', 'DetectionParam', 'DelegationFormTemplate', 'DataImage', 'DetectionParamStandard']
```

## 使用示例

```python
# 导入所有检测相关模型
from app.models.detection import Category, DetectionObject, DetectionStandard, DetectionItem, DetectionParam, DelegationFormTemplate

# 创建分类
category = Category(
    category_name="建筑材料",
    parent_id=None,  # 顶级分类
    sort_order=0,
    status=1
)

# 创建检测对象
detection_object = DetectionObject(
    object_name="普通硅酸盐水泥",
    category_id=category.category_id,
    description="普通硅酸盐水泥，强度等级42.5",
    status=1
)

# 创建检测规范
standard = DetectionStandard(
    standard_code="GB/T 175-2024",
    standard_name="通用硅酸盐水泥",
    standard_type="国家标准",
    status=1
)

# 创建检测项目
item = DetectionItem(
    object_id=detection_object.object_id,
    item_name="水泥物理性能检测",
    description="检测水泥的物理性能，包括抗压强度、抗折强度等",
    sort_order=0,
    status=1
)

# 创建检测参数（包含检测指南字段）
param = DetectionParam(
    item_id=item.item_id,
    param_name="抗压强度",
    material_name="普通硅酸盐水泥",
    price="50.00元/组",
    sample_processing_fee="20.00元/组",
    is_regular_param=1,
    sort_order=0,
    status=1,
    # 检测指南相关字段
    sampling_batch="每批次≤500吨取1组",
    sampling_frequency="每月1次",
    sampling_require="需使用无菌采样袋，采样量≥500g",
    inspection_require="样品需在24小时内送检",
    required_info="产品名称、批次号、生产日期、规格",
    report_time="常规5个工作日，加急3个工作日"
)

# 创建委托单模板
template = DelegationFormTemplate(
    template_name="水泥物理性能检测委托单",
    template_version="V2.0",
    file_type="docx",
    upload_user="admin",
    status=1,
    remark="水泥检测通用委托单模板"
)

# 关联检测规范
param.standards.append(standard)

# 保存模板，获取template_id
db.add(template)
db.flush()  # 获取template_id

# 关联委托单模板到检测参数
param.template_id = template.template_id

# 创建图片记录
data_image = DataImage(
    data_unique_id="detection:1",
    image_path="/images/sampling/cement.jpg",
    image_type="png",
    device_type="pc",
    status=1,
    remark="水泥检测采样图片"
)

# 保存图片记录
db.add(data_image)
db.commit()
```

## 模型扩展建议

1. **添加新模型**：继承`Base`类，在对应子目录中创建新模型文件
2. **添加新关系**：使用`relationship`和`ForeignKey`定义新的关联关系
3. **扩展现有模型**：在现有模型中添加新字段，更新数据库表结构
4. **添加中间表**：在`associations.py`中添加新的中间表模型

## 注意事项

1. **关系加载策略**：合理设置`lazy`参数，优化查询性能
2. **事务管理**：涉及多个模型的操作建议使用事务
3. **缓存策略**：考虑为频繁查询的数据添加缓存
4. **性能优化**：合理设置索引，优化查询性能
5. **数据一致性**：确保外键约束正确，维护数据一致性

## 总结

本系统的数据模型设计遵循了**分层架构**和**关系数据库设计原则**，核心模型之间通过外键和多对多关系建立了紧密的联系，形成了完整的数据体系。模型设计考虑了**扩展性**和**性能**，支持系统功能的持续扩展和优化。

检测参数表（DetectionParam）合并了检测指南相关字段，简化了数据模型结构，提高了数据查询效率。多对多关系采用**中间表模型**实现，便于扩展额外字段和关系属性。