## 问题分析

1. **认证时的用户状态验证问题**：
   - 登录时（`UserDAL.authenticate_user`）会检查`is_active=True`
   - 但令牌验证时（`AuthService.verify_token`和`AuthService.get_user_from_token`）没有检查用户的`is_active`状态
   - 导致禁用用户的令牌仍然可以访问系统

2. **禁用用户时的令牌失效问题**：
   - 目前`toggle_user_active`方法仅更新用户状态，没有处理令牌
   - 禁用用户后，其现有令牌仍有效，直到过期

## 修复方案

### 1. 在令牌验证中添加用户状态检查

**修改文件**：`app/services/auth/auth_service.py`
- 在`verify_token`方法中，获取用户后检查`is_active`状态
- 在`get_user_from_token`方法中，获取用户后检查`is_active`状态

### 2. 在禁用用户时处理令牌失效

**修改文件**：`app/services/admin/user_admin_service.py`
- 在`toggle_user_active`方法中，当`is_active=False`时：
  - 清除Redis中的用户令牌缓存
  - 将用户的访问令牌和刷新令牌添加到黑名单
  - 清除用户信息缓存

### 3. 确保get_user_with_permissions方法正确处理禁用用户

**修改文件**：`app/services/auth/auth_service.py`
- 确保`get_user_with_permissions`方法正确返回用户的`is_active`状态

## 实现步骤

1. 更新`AuthService.verify_token`方法，添加用户`is_active`检查
2. 更新`AuthService.get_user_from_token`方法，添加用户`is_active`检查
3. 更新`UserAdminService.toggle_user_active`方法，添加令牌失效处理逻辑
4. 测试修复后的功能，确保：
   - 禁用用户无法使用现有令牌访问系统
   - 禁用用户后，其令牌立即失效
   - 启用用户后，可正常登录获取新令牌

## 预期效果

- 认证流程会严格检查用户是否处于激活状态
- 禁用用户时，其所有现有令牌会立即失效
- 提高系统安全性，确保禁用用户无法访问系统
- 符合最佳安全实践，防止已禁用用户使用过期令牌访问