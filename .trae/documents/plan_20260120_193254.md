# 委托单模板使用情况查询功能实现

## 需求分析
- 实现查看委托单模板被使用情况的功能
- 通过模板ID查询关联的检测参数，再通过检测参数查询对应的检测项目，最后查询对应的检测对象
- 返回格式：`检测对象名称（启/禁用）--检测项目名称（启/禁用）--检测参数名称（启/禁用）`
- 以字符串列表形式返回

## 实现方案

### 1. 数据访问层修改
在 `app/dal/detection_dal.py` 中优化 `DetectionParamDAL.get_by_template_id` 方法，确保加载关联的检测项目和检测对象信息：

```python
def get_by_template_id(self, template_id: int) -> List[DetectionParam]:
    """
    根据委托单模板ID获取检测参数列表，包含关联的项目和对象信息
    :param template_id: 委托单模板ID
    :return: 检测参数列表
    """
    from sqlalchemy.orm import joinedload
    return self.db.query(self.model).filter_by(template_id=template_id).options(
        joinedload(self.model.item).joinedload(DetectionItem.detection_object)
    ).all()
```

### 2. 服务层实现
在 `app/services/detection/delegation_form_template_service.py` 中添加 `get_usage_info` 方法：

```python
@staticmethod
def get_usage_info(template_id):
    """
    获取委托单模板的使用情况
    :param template_id: 模板ID
    :return: 成功返回 (使用情况列表, None)，失败返回 (None, 错误信息)
    """
    # 用于保存需要关闭的数据库会话
    close_db_func = None
    try:
        db, redis, close_db_func = get_db_redis_direct()
        
        # 检查模板是否存在
        template_dal = DelegationFormTemplateDAL(db, redis)
        template = template_dal.get_by_id(template_id)
        if not template:
            return (None, f"委托单模板ID {template_id} 不存在")
        
        # 获取所有关联的检测参数
        param_dal = DetectionParamDAL(db, redis)
        params = param_dal.get_by_template_id(template_id)
        
        # 构建使用情况列表
        usage_list = []
        for param in params:
            # 获取检测对象、检测项目和检测参数信息
            obj = param.item.detection_object
            item = param.item
            
            # 获取状态文本
            obj_status = "启用" if obj.status == 1 else "禁用"
            item_status = "启用" if item.status == 1 else "禁用"
            param_status = "启用" if param.status == 1 else "禁用"
            
            # 拼接字符串
            usage_str = f"{obj.object_name}（{obj_status}）--{item.item_name}（{item_status}）--{param.param_name}（{param_status}）"
            usage_list.append(usage_str)
        
        return (usage_list, None)
    except Exception as e:
        return (None, f"获取委托单模板使用情况失败: {str(e)}")
    finally:
        # 如果是自己创建的会话，关闭它
        if close_db_func:
            close_db_func()
```

### 3. 路由层实现
在 `app/routes/detection/templates.py` 中添加新的路由：

```python
@router.get("/templates/{template_id}/usage", response_model=ResponseModel)
def get_template_usage(template_id: int):
    """获取委托单模板的使用情况"""
    usage_list, error = DelegationFormTemplateService.get_usage_info(template_id)
    if error:
        if "不存在" in error:
            raise HTTPException(status_code=404, detail=error)
        raise HTTPException(status_code=500, detail=error)
    return {"data": usage_list, "message": "获取委托单模板使用情况成功"}
```

## 预期效果
- 访问 `/api/detection/templates/{template_id}/usage` 接口，返回该模板的使用情况列表
- 返回格式示例：`["水泥（启用）--水泥物理性能检测（启用）--密度（禁用）", "钢筋（启用）--钢筋力学性能检测（禁用）--屈服强度（启用）"]`
- 每个字符串包含检测对象、检测项目和检测参数的名称及状态

## 涉及文件
- `app/dal/detection_dal.py`：优化 `get_by_template_id` 方法
- `app/services/detection/delegation_form_template_service.py`：添加 `get_usage_info` 方法
- `app/routes/detection/templates.py`：添加模板使用情况查询路由

该实现方案遵循了现有的代码结构和设计模式，确保了功能的完整性和可维护性。