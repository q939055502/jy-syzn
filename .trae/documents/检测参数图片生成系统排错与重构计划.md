# 检测参数图片生成系统排错与重构计划

## 一、问题分析

从前端反馈和服务日志来看，检测参数图片生成系统存在问题，前端无法正确显示图片。主要表现为：
1. 前端显示"图片加载失败"错误
2. 服务日志中存在"Cairo库缺失"错误
3. 图片生成流程耦合度高，难以定位问题

## 二、实施步骤

### 1. 抽离数据转SVG逻辑

**目标**：创建独立的SVG生成工具，不依赖数据库

**实现**：
- 创建 `app/utils/svg_generator.py` 文件
- 实现 `generate_detection_svg(item_name: str, params: list) -> str` 函数
- 该函数接收检测项目名称和参数列表，返回SVG字符串
- 确保函数纯函数特性，不依赖外部资源

### 2. 测试SVG生成逻辑

**目标**：验证SVG生成是否正确

**实现**：
- 创建 `test_svg_generator.py` 测试文件
- 编写测试用例，使用模拟数据调用SVG生成函数
- 验证生成的SVG结构完整性
- 可视化检查SVG输出是否符合预期

### 3. 抽离SVG转PNG逻辑

**目标**：创建独立的SVG转PNG工具

**实现**：
- 创建 `app/utils/svg_to_png_converter.py` 文件
- 实现 `convert_svg_to_png(svg_content: str, device_type: str) -> bytes` 函数
- 该函数接收SVG字符串和设备类型，返回PNG二进制数据
- 集成CairoSVG转换功能和防爬效果（水印、干扰点）

### 4. 测试SVG转PNG逻辑

**目标**：验证SVG转PNG过程是否正确

**实现**：
- 创建 `test_svg_to_png.py` 测试文件
- 编写测试用例，将生成的SVG转换为PNG
- 验证生成的PNG文件完整性和正确性
- 检查PNG文件大小和格式

### 5. 测试数据库存储与读取

**目标**：验证图片数据在数据库中的存储和读取是否正常

**实现**：
- 创建 `test_image_db.py` 测试文件
- 测试将生成的图片数据保存到数据库
- 测试从数据库读取图片数据并保存到本地 `images_from_db` 目录
- 验证本地保存的图片是否可正常打开

### 6. 重构原代码逻辑

**目标**：使用独立工具重构原图片生成服务

**实现**：
- 修改 `ImageService` 类，使用新创建的工具函数
- 优化图片生成流程，分离关注点
- 增强错误处理机制
- 确保各模块解耦，便于维护和调试

## 三、预期结果

1. **SVG生成工具**：独立、可测试、纯函数
2. **SVG转PNG工具**：独立、可测试、支持多设备
3. **完整测试套件**：覆盖所有核心流程
4. **重构后的图片服务**：解耦、健壮、易于维护
5. **前端正常显示**：图片加载成功，显示正确的检测参数表格

## 四、错误处理与优化

- 增强Cairo库缺失时的错误处理
- 优化图片生成性能
- 改进日志记录，便于问题定位
- 添加图片生成状态监控

## 五、文档输出

最后生成《检测参数图片生成系统排错报告》，包含：
- 问题原因分析
- 解决方案详解
- 重构前后对比
- 测试结果
- 优化建议