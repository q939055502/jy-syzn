## 修复路由请求格式问题计划

### 1. 修复登录请求格式不标准问题

* **问题**：`/api/auth/token` 使用自定义的 `LoginRequest` 模型，而非 FastAPI 内置的 `OAuth2PasswordRequestForm`

* **解决方案**：

  * 修改 `auth.py` 中的 `/token` 路由，使用 `OAuth2PasswordRequestForm` 替代自定义的 `LoginRequest` 模型

  * 确保与标准 OAuth2 流程兼容

### 2. 修复管理员权限检查逻辑错误

* **问题**：`admin.py` 中的 `get_current_admin` 函数使用 `current_user.role != "admin"` 检查管理员权限，但 User 模型中角色是通过 `roles` 多对多关系定义的

* **解决方案**：

  * 修改 `get_current_admin` 函数，检查用户是否拥有管理员角色

  * 使用 `current_user.get_permission_codes()` 或类似方法检查权限

### 3. 统一导入路径

* **问题**：部分文件中 `from app.models.user import User` 导入路径不正确，正确路径应为 `from app.models.user.user import User`

* **解决方案**：

  * 在所有文件中统一 User 模型的导入路径

  * 检查并修复其他可能的导入路径问题

### 4. 完善 JWT 注销功能

* **问题**：`/api/auth/logout` 仅返回成功消息，但 JWT 令牌无法主动失效

* **解决方案**：

  * 实现令牌黑名单机制，使用 Redis 存储已注销的令牌

  * 修改 `AuthService.verify_token` 方法，检查令牌是否在黑名单中

  * 更新 `/logout` 路由，将令牌添加到黑名单

### 5. 统一请求参数处理方式

* **问题**：部分路由使用多个 `Body(...)` 参数获取单个字段，而非统一的 Pydantic 模型

* **解决方案**：

  * 为 `admin.py` 中的所有请求创建对应的 Pydantic 模型

  * 修改相关路由，使用统一的 Pydantic 模型处理请求体

### 6. 统一依赖注入逻辑

* **问题**：部分路由使用 `Depends(get_db_and_redis)` 获取数据库和 Redis 连接，部分服务层函数自己获取连接

* **解决方案**：

  * 统一依赖注入方式，在路由层获取数据库和 Redis 连接后传递给服务层

  * 修改服务层函数，接受数据库和 Redis 连接作为参数

### 7. 完善角色管理逻辑

* **问题**：管理员路由中的角色管理逻辑与 User 模型的多对多关系定义不一致

* **解决方案**：

  * 修改角色管理相关路由，使用多对多关系正确处理用户角色

  * 确保角色管理功能与 User 模型的定义一致

### 修复步骤

1. 修复导入路径问题
2. 修复管理员权限检查逻辑
3. 统一请求参数处理方式
4. 统一依赖注入逻辑
5. 完善 JWT 注销功能
6. 修复登录请求格式
7. 完善角色管理逻辑

### 预期效果

* 所有路由请求格式统一规范

* 权限检查逻辑正确可靠

* JWT 注销功能完整有效

* 代码结构清晰，易于维护

* 与标准 OAuth2 流程兼容

