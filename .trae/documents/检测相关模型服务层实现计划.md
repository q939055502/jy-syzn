## 检测相关模型服务层实现计划

### 1. 服务层结构设计

在 `app/services` 目录下创建 `detection` 子目录，包含以下服务类：

| 模型名称 | 服务类名称 | 服务文件 |
|----------|------------|----------|
| Category | CategoryService | category_service.py |
| DetectionStandard | DetectionStandardService | detection_standard_service.py |
| DetectionGroup | DetectionGroupService | detection_group_service.py |
| DetectionItem | DetectionItemService | detection_item_service.py |
| DetectionGuide | DetectionGuideService | detection_guide_service.py |
| DelegationFormTemplate | DelegationFormTemplateService | delegation_form_template_service.py |

### 2. 服务层实现要点

#### 2.1 基本CRUD操作
每个服务类将实现以下基本操作：
- `get_by_id`：根据ID获取单个对象
- `get_all`：获取所有对象列表
- `create`：创建新对象
- `update`：更新对象
- `delete`：删除对象
- `get_by_xxx`：根据特定字段获取对象

#### 2.2 关联表处理
- 对于需要关联其他表的字段，在创建和更新时进行关联检查
- 检查关联表中是否存在对应记录
- 如不存在，返回明确的失败原因

#### 2.3 不可空字段处理
- 对不可空字段进行验证
- 如未提供，返回明确的失败原因

#### 2.4 异常处理
- 捕获数据库操作异常
- 返回结构化的错误信息，包含错误码和错误描述
- 使用try-except块处理可能的失败情况

#### 2.5 返回格式
每个服务方法返回一个包含两个元素的元组：
- 成功：`(对象/True, None)`
- 失败：`(None, 错误信息)`

### 3. 服务层实现示例

以 `CategoryService` 为例，实现基本的CRUD操作：

```python
class CategoryService:
    """分类服务类，处理分类相关的业务逻辑"""
    
    @staticmethod
    def get_by_id(category_id):
        # 实现获取单个分类的逻辑
        pass
    
    @staticmethod
    def create(category_data):
        # 验证不可空字段
        # 检查关联表记录
        # 创建分类
        # 处理异常
        pass
    
    # 其他方法...
```

### 4. 实现步骤

1. 创建 `app/services/detection` 目录和 `__init__.py` 文件
2. 为每个检测相关模型创建服务文件
3. 实现每个服务类的CRUD操作
4. 实现关联表检查和不可空字段验证
5. 添加异常处理和错误返回
6. 在 `__init__.py` 中导出所有服务类
7. 测试服务层功能

### 5. 技术要点

- 使用 `get_db()` 获取数据库会话
- 实现事务管理（commit/rollback）
- 验证关联表记录存在性
- 返回结构化的错误信息
- 遵循项目现有的服务层设计模式

### 6. 预期结果

- 完成所有检测相关模型的服务层实现
- 服务层能够正确处理各种失败情况
- 返回明确的失败原因
- 符合项目的代码规范和设计模式

### 7. 测试方法

- 创建单元测试，验证服务层的各种情况
- 测试成功创建、更新、删除操作
- 测试关联表记录不存在的情况
- 测试不可空字段未提供的情况
- 测试重复记录的情况

通过这个计划，我们将为检测相关模型创建完整的服务层，确保在处理不可空且需关联其他表的情况时，能够正确返回失败原因，提高系统的可靠性和用户体验。