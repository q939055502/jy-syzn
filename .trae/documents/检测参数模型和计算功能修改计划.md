# 检测参数模型和计算功能修改计划

## 1. 修改检测参数模型

### 1.1 更新 `detection_param.py` 模型
- 将 `price` 字段类型从 `Numeric(10, 2)` 改为 `String(100)`，支持直接带单位存储价格
- 移除 `unit` 和 `sample_unit` 字段
- 更新 `to_dict` 方法，移除相关字段的处理

### 1.2 更新相关服务层代码
- 检查 `detection_param_service.py`，确保兼容新的价格字段类型
- 移除与 `unit` 和 `sample_unit` 相关的处理逻辑

## 2. 移除计算功能

### 2.1 删除计算相关路由文件
- 删除 `app/routes/detection/calculations.py` 文件，该文件包含所有计算相关接口：
  - `/sample-rules` - 样品规则查询
  - `/calculate-batches` - 组批计算
  - `/sampling-requirements` - 送检要求计算

### 2.2 更新检测指南服务
- 修改 `detection_guide_service.py`，移除 `add_param` 方法中的组批规则处理
- 删除与组批规则相关的参数和逻辑

### 2.3 更新关联表模型
- 检查 `associations.py` 中的 `DetectionParamGuide` 中间表
- 移除组批规则相关字段：`batch_size`, `batch_unit`, `sample_quantity_per_batch`, `sample_size_min`, `sample_size_max`, `sample_size_unit`

## 3. 更新Schema定义

### 3.1 修改检测参数Schema
- 更新 `app/schemas/detection.py` 中的检测参数相关模型
- 将价格字段类型从 `float` 改为 `str`
- 移除 `unit` 和 `sample_unit` 字段

### 3.2 删除计算相关Schema
- 删除 `CalculateBatchesRequest` 和 `CalculateBatchesResponse` 模型
- 删除 `SamplingRequirementsRequest` 模型

## 4. 数据库表重建

### 4.1 准备表重建脚本
- 由于修改了核心表结构，需要重新创建 `detection_param` 表
- 考虑使用SQLAlchemy的迁移工具或直接删除重建

### 4.2 更新初始化数据
- 修改 `init_user_data.py`，移除 `unit` 和 `sample_unit` 字段
- 更新价格数据，直接带单位存储，如 `"price": "50.00元/组"`

## 5. 测试修改后的功能

### 5.1 测试检测参数CRUD
- 测试创建检测参数功能
- 测试查询检测参数功能
- 测试更新检测参数功能
- 测试删除检测参数功能

### 5.2 测试相关API接口
- 测试检测参数列表接口
- 测试检测参数详情接口
- 测试检测项目与参数的关联功能

## 6. 更新文档

### 6.1 更新模型说明文档
- 修改 `app/models/detection/模型说明.md`
- 更新检测参数模型的描述，移除与计算相关的内容
- 删除组批规则相关的说明

### 6.2 更新API文档
- 修改 `API_DOCUMENTATION.md`
- 更新检测参数相关接口的请求和响应格式
- 删除与计算相关的接口文档

## 7. 清理冗余代码

### 7.1 检查其他文件
- 搜索并移除所有引用已删除字段和功能的代码
- 确保没有遗留的计算功能调用

### 7.2 更新导入语句
- 移除所有导入已删除模型和函数的语句
- 修复因代码删除导致的导入错误

## 8. 最终验证

### 8.1 启动应用程序
- 确保应用程序能够正常启动
- 检查是否有任何运行时错误

### 8.2 全面功能测试
- 测试所有检测相关功能
- 确保没有因修改导致的功能异常

## 预期结果

1. 检测参数价格改为文本型，支持直接带单位存储
2. 移除了 `unit` 和 `sample_unit` 属性
3. 所有计算功能和相关接口已移除
4. 检测参数表已重建
5. 所有相关文档已更新
6. 应用程序能够正常运行，无异常错误

## 潜在风险和应对措施

1. **数据库表重建风险**：
   - 应对：在重建前备份数据，确保数据安全

2. **代码依赖风险**：
   - 应对：仔细检查所有文件，确保没有遗留的依赖关系

3. **API兼容性风险**：
   - 应对：更新所有相关文档，确保前端开发人员了解API变更

4. **测试覆盖风险**：
   - 应对：进行全面的功能测试，确保所有修改后的功能正常工作