# 删除规范错误处理修复计划

## 1. 问题分析

从日志和代码分析，存在以下问题：
- 前端显示错误消息："检测规范被1个检测项目组使用，无法删除"
- 路由代码应该返回400状态码，但实际返回了500
- 路由代码中有条件：`if "被引用" in error or "被使用" in error:`，但可能匹配失败

## 2. 原因分析

可能的原因：
1. 错误消息格式与预期不符
2. 字符串匹配逻辑有问题
3. 服务层返回的错误类型不是字符串

## 3. 修复方案

### 3.1 优化错误处理逻辑
- 检查错误消息是否为字符串类型
- 增强字符串匹配的健壮性
- 增加日志记录，便于调试

### 3.2 具体修改
1. **修改路由层代码**：
   - 增加错误类型检查
   - 增强字符串匹配逻辑
   - 增加日志记录
2. **保持错误消息格式不变**：
   - 确保包含"被使用"或"被引用"的错误返回400
   - 其他错误返回500

## 4. 预期效果

- 当规范被使用时，返回400状态码和具体错误信息
- 当规范不存在时，返回404状态码
- 其他错误返回500状态码
- 便于前端根据状态码进行不同的错误处理

## 5. 实现步骤

1. **修改路由层错误处理**：
   - 增加错误类型检查
   - 增强字符串匹配逻辑
   - 增加日志记录
2. **测试修复效果**：
   - 测试规范被使用的情况，确认返回400
   - 测试规范不存在的情况，确认返回404
   - 测试其他错误情况，确认返回500

## 6. 代码示例

修改前：
```python
if error:
    if "不存在" in error:
        raise HTTPException(status_code=404, detail=error)
    if "被引用" in error or "被使用" in error:
        raise HTTPException(status_code=400, detail=error)
    raise HTTPException(status_code=500, detail=error)
```

修改后：
```python
if error:
    # 确保error是字符串
    error_str = str(error)
    print(f"Delete standard error: {error_str}")  # 增加日志
    if "不存在" in error_str:
        raise HTTPException(status_code=404, detail=error_str)
    if "被引用" in error_str or "被使用" in error_str:
        raise HTTPException(status_code=400, detail=error_str)
    raise HTTPException(status_code=500, detail=error_str)
```

## 7. 前端处理方式

- **400错误**：显示具体错误信息，如"检测规范被1个检测项目组使用，无法删除"
- **404错误**：显示"检测规范不存在"
- **500错误**：显示"服务器内部错误，请稍后重试"

这样的处理方式既符合HTTP规范，又能给用户提供清晰的错误信息。