# 样品检测组批和送检要求计算功能实现计划

## 一、核心模型修改

### 1. DetectionItem（检测项目）

**修改内容**：

* 新增字段：

  * `sample_unit`：样品单位（如"根"、"组"等）

  * `is_regular_param`：布尔值，标记该检测参数是否为常规参数

**字段定义**：

```python
sample_unit = Column(String(50), nullable=True, comment='样品单位，如根、组等')
is_regular_param = Column(Integer, default=1, comment='是否为常规参数：1=是，0=否')
```

### 2. DetectionGuide（检测指南）

**修改内容**：

* 优化现有字段：

  * 保留 `sampling_batch` 字段，用于存储完整的组批规则描述

  * 保留 `sampling_require` 字段，用于存储详细的送检要求

* 新增结构化组批规则字段：

  * `batch_size`：批次大小数值（如60）

  * `batch_unit`：批次单位（如"吨"、"件"等）

  * `sample_quantity_per_batch`：每批次样品数量（如5）

  * `sample_size_min`：样品最小尺寸（如580）

  * `sample_size_max`：样品最大尺寸（如610）

  * `sample_size_unit`：样品尺寸单位（如"mm"）

* 新增媒体资源字段：

  * `sample_image_path`：取样方法示意图路径

  * `sample_video_path`：取样方法视频路径

**字段定义**：

```python
batch_size = Column(Numeric(10, 2), nullable=True, comment='批次大小数值')
batch_unit = Column(String(50), nullable=True, comment='批次单位')
sample_quantity_per_batch = Column(Integer, nullable=True, comment='每批次样品数量')
sample_size_min = Column(Numeric(10, 2), nullable=True, comment='样品最小尺寸')
sample_size_max = Column(Numeric(10, 2), nullable=True, comment='样品最大尺寸')
sample_size_unit = Column(String(20), nullable=True, comment='样品尺寸单位')
sample_image_path = Column(String(255), nullable=True, comment='取样方法示意图路径')
sample_video_path = Column(String(255), nullable=True, comment='取样方法视频路径')
```

## 二、核心功能实现

### 1. 样品查询功能

**API 设计**：

* 路径：`/api/detection/sample-rules`

* 方法：`GET`

* 参数：`sample_name`（样品名称，如"钢筋原材"）

* 返回：检测项目列表，包含组批规则、送检要求、媒体资源路径等

**实现逻辑**：

* 通过 `material_name` 查询相关的 `DetectionItem`

* 对每个 `DetectionItem`，获取关联的 `DetectionGuide`

* 返回结构化的样品检测规则信息

### 2. 组批计算功能

**API 设计**：

* 路径：`/api/detection/calculate-batches`

* 方法：`POST`

* 请求体：

  ```json
  {
    "sample_name": "钢筋原材",
    "total_quantity": 100,
    "detection_item_id": 1
  }
  ```

* 返回：批次计算结果，包含批次数量、每批次样品数量、总样品数量等

**实现逻辑**：

* 根据 `sample_name` 和 `detection_item_id` 查询 `DetectionGuide`

* 获取 `batch_size` 和 `batch_unit`

* 计算批次数量：`ceil(total_quantity / batch_size)`

* 返回计算结果

### 3. 送检要求计算功能

**API 设计**：

* 路径：`/api/detection/sampling-requirements`

* 方法：`POST`

* 请求体：

  ```json
  {
    "detection_item_id": 1,
    "batch_count": 2
  }
  ```

* 返回：详细送检要求，包含总样品数量、样品尺寸要求、媒体资源路径等

**实现逻辑**：

* 根据 `detection_item_id` 查询 `DetectionGuide`

* 获取 `sample_quantity_per_batch`、`sample_size_min`、`sample_size_max` 等信息

* 计算总样品数量：`batch_count × sample_quantity_per_batch`

* 返回完整的送检要求

## 三、初始化脚本修改

### 1. 检测数据初始化

**修改文件**：`init_user_data.py`

**修改内容**：

* 增加检测项目和检测指南的初始化数据

* 为钢筋等常见样品添加完整的检测规则

* 包含组批规则、送检要求、媒体资源路径等

**示例数据**：

```python
# 钢筋原材检测项目
detection_item = DetectionItem(
    group_id=group.group_id,
    material_name="钢筋原材",
    item_name="重量偏差试验",
    sample_unit="根",
    is_regular_param=1,
    price=100.00,
    unit="组",
    status=1
)

# 钢筋重量偏差检测指南
detection_guide = DetectionGuide(
    sampling_batch="同一牌号、同规格、同炉号、同交货状态的每60吨为一批",
    sampling_require="做重量偏差需要5根，每根长580-610mm",
    batch_size=60,
    batch_unit="吨",
    sample_quantity_per_batch=5,
    sample_size_min=580,
    sample_size_max=610,
    sample_size_unit="mm",
    sample_image_path="/static/sampling/steel_weight.jpg",
    sample_video_path="/static/sampling/steel_weight.mp4"
)

detection_item.guides.append(detection_guide)
```

## 四、测试脚本修改

### 1. 功能测试脚本

**创建文件**：`test_sample_detection.py`

**测试内容**：

* 样品查询功能测试

* 组批计算功能测试（如100吨钢筋计算为2批）

* 送检要求计算功能测试（如2批需要10根样品）

* 检测参数常规性标记测试

* 媒体资源路径返回测试

## 五、API 路由实现

### 1. 路由定义

**文件**：`app/routes/detection.py`

**新增路由**：

```python
@router.get("/sample-rules", summary="根据样品名称查询检测规则")
def get_sample_rules(sample_name: str):
    # 实现逻辑
    pass

@router.post("/calculate-batches", summary="计算检测批次")
def calculate_batches(request: CalculateBatchesRequest):
    # 实现逻辑
    pass

@router.post("/sampling-requirements", summary="计算送检要求")
def get_sampling_requirements(request: SamplingRequirementsRequest):
    # 实现逻辑
    pass
```

### 2. 请求模型定义

**文件**：`app/schemas/detection.py`

**新增模型**：

```python
class CalculateBatchesRequest(BaseModel):
    sample_name: str
    total_quantity: float
    detection_item_id: int

class SamplingRequirementsRequest(BaseModel):
    detection_item_id: int
    batch_count: int
```

## 六、实现步骤

1. **修改核心模型**：

   * 更新 `DetectionItem` 模型

   * 更新 `DetectionGuide` 模型

2. **实现 API 路由**：

   * 定义请求和响应模型

   * 实现样品查询功能

   * 实现组批计算功能

   * 实现送检要求计算功能

3. **修改初始化脚本**：

   * 添加检测项目和检测指南的初始化数据

4. **创建测试脚本**：

   * 编写功能测试用例

   * 验证核心功能正确性

5. **测试和验证**：

   * 运行初始化脚本，创建测试数据

   * 运行测试脚本，验证功能正确性

   * 手动测试 API 接口

## 七、技术要点

1. **数据结构化**：将组批规则拆分为结构化字段，便于计算和展示
2. **灵活的关联关系**：支持一个检测项目对应多个检测指南
3. **精确的计算逻辑**：使用 `math.ceil` 函数确保批次数量向上取整
4. **完整的媒体资源支持**：提供图片和视频路径，便于用户查看取样方法
5. **清晰的 API 设计**：返回结构化的响应数据，便于前端展示和处理

该实现计划将确保系统能够满足用户的需求，提供完整的样品检测组批和送检要求计算功能。
