# 实现组合依赖函数和数据一致性处理计划

## 1. 实现目标

1. 在`app/extensions.py`中添加组合依赖函数`get_db_and_redis`，方便同时获取MySQL和Redis连接
2. 实现数据访问层（DAL）来封装数据库和Redis操作，确保数据一致性
3. 更新现有的service文件，使用新的DAL层来处理数据访问
4. 确保数据一致性：
   - 查询时优先从缓存获取，缓存不存在则从数据库获取
   - 更新数据时同时更新缓存
   - 删除数据时同时删除缓存

## 2. 实现步骤

### 2.1 在`app/extensions.py`中添加组合依赖函数

1. 添加`get_db_and_redis`函数，同时返回MySQL和Redis连接
2. 确保函数的类型提示正确
3. 添加适当的错误处理

### 2.2 创建数据访问层（DAL）

1. 创建`app/dal`目录（如果不存在）
2. 创建`app/dal/base_dal.py`，包含基础数据访问类
3. 实现基础的CRUD操作，包含缓存处理
4. 确保数据一致性：
   - 查询时优先从缓存获取
   - 更新时更新缓存
   - 删除时删除缓存

### 2.3 为每个模型创建DAL类

1. 为主要模型创建DAL类，继承自BaseDAL
2. 实现模型特定的查询方法
3. 确保每个方法都包含适当的缓存处理

### 2.4 更新现有service文件

1. 更新service文件，使用新的DAL层代替直接调用get_db
2. 确保所有数据操作都通过DAL层进行
3. 测试service的功能是否正常

## 3. 技术要点

1. **数据一致性**：通过DAL层统一处理数据库和缓存操作，确保数据一致性
2. **缓存策略**：
   - 使用模型名称和ID作为缓存键
   - 缓存过期时间设置为1小时
   - 更新和删除操作时同步更新缓存
3. **依赖注入**：使用FastAPI的依赖注入机制提供DAL实例
4. **错误处理**：添加适当的异常处理，确保应用稳定性
5. **类型安全**：使用类型提示确保代码安全性

## 4. 实现细节

### 4.1 BaseDAL类设计

```python
class BaseDAL:
    def __init__(self, db, redis):
        self.db = db
        self.redis = redis
    
    def get_by_id(self, model, id, cache_expire=3600):
        # 尝试从缓存获取
        # 缓存不存在则从数据库获取
        # 将结果存入缓存
        pass
    
    def save(self, instance, cache_expire=3600):
        # 保存到数据库
        # 更新缓存
        pass
    
    def delete(self, instance):
        # 删除缓存
        # 删除数据库中的数据
        pass
```

### 4.2 Service更新示例

```python
class DetectionItemService:
    @staticmethod
    def get_by_id(item_id):
        try:
            # 使用组合依赖函数获取数据库和Redis连接
            db, redis = next(get_db_and_redis())
            # 创建DAL实例
            dal = DetectionItemDAL(db, redis)
            # 使用DAL获取数据
            item = dal.get_by_id(item_id)
            if item:
                return (item, None)
            else:
                return (None, f"检测项目ID {item_id} 不存在")
        except Exception as e:
            return (None, f"获取检测项目失败: {str(e)}")
```

## 5. 预期效果

1. 简化service层的代码，不需要同时调用get_db和get_redis
2. 确保数据一致性，避免缓存和数据库不一致的问题
3. 提高代码的可维护性和可读性
4. 支持缓存的统一管理和配置
5. 方便扩展和测试

## 6. 风险评估

1. **性能影响**：添加缓存处理可能会增加一些额外的开销，但总体性能会得到提升
2. **数据一致性**：通过DAL层统一处理，可以有效避免数据不一致的问题
3. **代码复杂度**：添加DAL层会增加一些代码复杂度，但会提高代码的可维护性
4. **缓存失效**：设置合理的缓存过期时间可以有效避免缓存失效的问题

## 7. 测试计划

1. 测试service的基本功能是否正常
2. 测试缓存机制是否正常工作
3. 测试数据一致性：
   - 更新数据后，缓存是否同步更新
   - 删除数据后，缓存是否同步删除
4. 测试错误处理是否正常
5. 测试性能是否有提升

通过以上实现，我们可以简化service层的代码，同时确保数据一致性，提高应用的性能和可维护性。