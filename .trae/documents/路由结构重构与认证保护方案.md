# 路由结构重构与认证保护方案

## 一、需求分析
1. **路由模块化**：将 `public.py` 重构为 `public` 包，按功能分开存放
2. **认证控制**：
   - 现有检测接口（`/api/detection`）需要登录才能访问
   - 公开接口（如文件下载）无需登录即可访问
3. **结构清晰**：区分内部受保护接口和外部公开接口

## 二、修改方案

### 1. 路由结构重构

#### 1.1 创建 public 包结构
```
app/routes/
├── public/
│   ├── __init__.py        # public路由注册
│   ├── dependencies.py    # 公开路由依赖（暂无）
│   └── files.py           # 文件下载相关接口
├── detection/             # 现有检测路由（需添加认证）
├── admin/                 # 现有管理员路由
├── auth.py                # 现有认证路由
└── __init__.py            # 主路由导出
```

#### 1.2 重构 public 路由
- 将 `public.py` 中的文件下载接口迁移到 `public/files.py`
- 在 `public/__init__.py` 中注册公开路由
- 公开路由前缀统一为 `/api/public`

### 2. 认证保护实现

#### 2.1 创建通用认证依赖
- 在 `app/routes/dependencies.py` 中实现通用认证依赖
- 包含 `get_current_user` 和 `get_current_active_user` 函数

#### 2.2 保护检测路由
- 为 `detection` 路由添加认证依赖
- 所有 `/api/detection` 接口需要登录才能访问
- 保持检测路由现有功能不变

### 3. 路由注册调整

#### 3.1 更新主路由注册
- 修改 `app.py` 中的路由注册逻辑
- 确保公开路由无需认证
- 内部路由统一添加认证保护

#### 3.2 更新路由导出
- 修改 `app/routes/__init__.py`，导出所有必要路由

## 三、具体文件修改

### 1. 创建 `app/routes/dependencies.py`
```python
# 通用认证依赖
from fastapi import Depends, HTTPException, status
from fastapi.security import OAuth2PasswordBearer
from app.services.auth.auth_service import AuthService
from app.models.user.user import User

# OAuth2 密码流配置
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/api/auth/token")

def get_current_user(token: str = Depends(oauth2_scheme)):
    """获取当前用户，验证token有效性"""
    user = AuthService.get_user_from_token(token)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="无效的访问令牌",
            headers={"WWW-Authenticate": "Bearer"},
        )
    return user

def get_current_active_user(current_user: User = Depends(get_current_user)):
    """获取当前活跃用户"""
    return current_user
```

### 2. 重构 public 包

#### 2.1 创建 `app/routes/public/__init__.py`
```python
from fastapi import APIRouter

# 创建公开路由实例
router = APIRouter(prefix="/api/public", tags=["public"])

# 导入子路由
from .files import router as files_router

# 注册子路由
router.include_router(files_router)
```

#### 2.2 创建 `app/routes/public/files.py`
```python
# 迁移原public.py中的文件下载接口
from fastapi import APIRouter, HTTPException, Response
from pathlib import Path
import os

# 创建路由实例
router = APIRouter(prefix="/files", tags=["public/files"])

# 获取项目根目录
PROJECT_ROOT = Path(__file__).parent.parent.parent.parent

# 允许下载的文件路径前缀列表
ALLOWED_PREFIXES = [
    Path("static"),
    Path("upload"),
    Path("files")
]

# 复制原public.py中的validate_file_path函数和download_file端点
# ...（保持原有实现不变）
```

### 3. 为 detection 路由添加认证保护

#### 3.1 修改 `app/routes/detection/__init__.py`
```python
from fastapi import APIRouter, Depends
from app.routes.dependencies import get_current_active_user

# 创建主路由实例，添加认证依赖
router = APIRouter(
    prefix="/api/detection",
    tags=["detection"],
    dependencies=[Depends(get_current_active_user)]  # 添加全局认证依赖
)

# 导入并注册子路由（保持不变）
# ...
```

### 4. 更新主路由注册

#### 4.1 修改 `app/routes/__init__.py`
```python
# API路由包

# 导出路由
from app.routes.detection import router as detection_router
from app.routes.auth import router as auth_router
from app.routes.public import router as public_router

__all__ = [
    'detection_router',
    'auth_router',
    'public_router'
]
```

#### 4.2 更新 `app.py` 中的路由注册
```python
# 注册路由（保持现有顺序不变）
app.include_router(detection_router)  # 已添加认证保护
app.include_router(auth_router)        # 公开路由
app.include_router(register_admin_routes())  # 管理员路由，已有认证
app.include_router(public_router)      # 公开路由，无需认证
```

## 四、测试验证
1. **内部接口测试**：验证 `/api/detection/params` 等接口需要登录
2. **公开接口测试**：验证 `/api/public/files/download/...` 无需登录
3. **认证流程测试**：验证登录后可正常访问内部接口
4. **路由结构测试**：验证路由模块化后功能正常

## 五、预期效果
1. **结构清晰**：路由按功能和权限等级分类
2. **安全可控**：内部接口需登录，外部接口公开访问
3. **扩展性强**：新增功能可按模块添加，易于维护
4. **符合最佳实践**：遵循分层架构和依赖注入原则

## 六、后续扩展建议
1. **细化权限控制**：为不同角色分配不同权限
2. **添加API文档**：集成Swagger/Redoc文档
3. **添加速率限制**：防止API滥用
4. **实现日志记录**：便于追踪和调试