# 新图片生成接口实现计划

## 一、需求分析

根据用户需求，需要添加一个新的图片生成接口，具体要求如下：

1. **功能需求**：
   - 接收检测项目ID和检测项目名称作为参数
   - 根据项目ID查询该项目下状态为启用的所有检测参数
   - 生成符合特定格式的SVG图片
   - 转换为PNG格式并返回
   - 不需要异步处理

2. **图片格式要求**：
   - 标题展示检测项目名称
   - 第一列：参数和单价（常规参数显示红色）
   - 中间列：组批规则、取样频率、取样要求、送检要求、所需信息、检评规范
   - 最后一列备注："需提供见证记录" + 报告时间

3. **技术要求**：
   - 沿用现有图片生成系统的防爬机制
   - 支持多设备适配
   - 与现有代码风格保持一致

## 二、实现方案

### 1. 服务层修改

**文件**：`app/services/image/image_service.py`

**修改内容**：
- 添加`generate_detection_svg`方法：生成符合检测参数格式的SVG
- 该方法接收检测项目名称和检测参数列表，返回格式化的SVG字符串
- SVG包含表格结构，根据检测参数数据动态生成行
- 支持常规参数的红色显示
- 添加必要的抗爬机制（文本偏移、旋转等）

### 2. API接口添加

**文件**：`app/routes/image.py`

**修改内容**：
- 添加`POST /api/image/detection`接口
- 接收参数：
  - `item_id`：检测项目ID
  - `item_name`：检测项目名称
  - `device_type`：设备类型（可选，默认pc）
- 实现逻辑：
  1. 根据`item_id`获取状态为启用的检测参数
  2. 调用`generate_detection_svg`生成SVG
  3. 调用`svg_to_png`转换为PNG
  4. 返回PNG二进制数据

### 3. 辅助功能

**文件**：`app/services/detection/detection_param_service.py`

**修改内容**：
- 添加`get_enabled_by_item_id`方法：根据项目ID获取所有启用的检测参数
- 确保返回的数据包含生成图片所需的所有字段

## 三、实现步骤

1. **修改ImageService**：
   - 实现`generate_detection_svg`方法
   - 确保SVG生成符合要求的表格格式
   - 添加抗爬机制

2. **修改DetectionParamService**：
   - 添加`get_enabled_by_item_id`方法
   - 优化检测参数查询逻辑

3. **添加API接口**：
   - 在`image.py`中添加新的路由
   - 实现接口逻辑
   - 添加必要的参数验证

4. **测试**：
   - 验证接口能够正确获取检测参数
   - 验证生成的SVG格式正确
   - 验证转换的PNG图片符合要求
   - 验证多设备适配功能

## 四、技术要点

1. **SVG表格生成**：
   - 使用动态计算的表格尺寸
   - 实现单元格合并和样式控制
   - 支持不同设备的响应式设计

2. **抗爬机制**：
   - 文本随机偏移和旋转
   - 水印添加
   - 随机干扰点

3. **性能优化**：
   - 高效的数据库查询
   - 合理的缓存策略
   - 优化SVG生成和转换过程

4. **代码规范**：
   - 遵循现有代码风格
   - 添加详细的注释
   - 确保代码可维护性和可扩展性

## 五、预期效果

1. 成功添加新的图片生成接口
2. 接口能够根据检测项目ID和名称生成符合要求的PNG图片
3. 生成的图片包含所有必要的检测参数信息
4. 图片具有良好的抗爬性能
5. 支持多设备适配
6. 接口响应迅速，不需要异步处理

## 六、风险评估

1. **SVG生成复杂度**：需要生成复杂的表格结构，可能存在布局问题
2. **性能问题**：如果检测参数数量较多，可能影响生成速度
3. **设备适配**：不同设备的显示效果可能存在差异

## 七、解决方案

1. **SVG生成**：使用成熟的SVG生成库，确保表格布局正确
2. **性能优化**：优化数据库查询，使用缓存机制，合理控制生成图片的尺寸
3. **设备适配**：根据不同设备类型生成不同尺寸的图片，确保显示效果一致

## 八、代码质量保证

1. **测试覆盖率**：添加单元测试和集成测试
2. **代码审查**：确保代码符合项目规范
3. **文档更新**：更新API文档，说明新接口的使用方法
4. **性能测试**：测试接口在不同负载下的表现

通过以上实现计划，我们可以确保新的图片生成接口能够满足用户需求，并且具有良好的性能和可维护性。