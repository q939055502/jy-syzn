# 委托单下载链接优化实现计划

## 一、实现目标
1. 集中化管理下载链接生成逻辑
2. 实现带签名和过期时间的临时下载链接
3. 增强下载链接的安全性
4. 统一所有下载链接的生成格式
5. 支持访问控制和链接失效机制

## 二、实现步骤

### 1. 创建链接生成服务
- 创建 `app/services/utils/link_generator.py` 文件
- 实现 `LinkGeneratorService` 类，包含：
  - `generate_signed_url` 方法：生成带签名和过期时间的下载链接
  - `validate_signed_url` 方法：验证链接签名和有效性
  - 签名算法：基于文件路径、过期时间和密钥生成HMAC签名

### 2. 更新文件下载路由
- 修改 `app/routes/public/files.py` 文件
- 添加带签名验证的下载接口 `download_signed`
- 保留原有接口但添加废弃标记

### 3. 替换原有链接生成逻辑
- 修改 `app/services/detection/delegation_form_template_service.py`：使用新的链接生成服务
- 修改 `app/routes/public/detection.py`：更新委托单模板下载链接生成
- 修改 `app/models/detection/detection_param.py`：更新模型中链接生成逻辑

### 4. 添加配置和依赖
- 在 `.env` 文件中添加链接生成相关配置（密钥、默认过期时间等）
- 更新 `app/config.py` 读取新配置

### 5. 测试验证
- 测试链接生成功能：验证生成的链接格式和签名正确性
- 测试链接验证功能：验证过期链接、无效签名的处理
- 测试现有功能：确保原有功能不受影响

## 三、核心技术点
1. **HMAC签名算法**：使用SHA-256生成安全签名
2. **URL编码**：确保特殊字符在URL中正确处理
3. **过期时间验证**：基于服务器时间验证链接有效性
4. **安全路径处理**：防止目录遍历攻击
5. **集中式配置**：支持灵活调整链接有效期和密钥

## 四、预期效果
1. 所有下载链接统一格式，带签名和过期时间
2. 增强安全性，防止未授权访问和链接盗用
3. 便于审计和统计链接使用情况
4. 支持灵活的访问控制策略
5. 统一的代码管理，便于维护和扩展