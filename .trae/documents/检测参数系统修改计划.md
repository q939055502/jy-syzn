# 检测参数系统修改计划

## 一、修改内容

### 1. 检测参数查询返回检测对象信息
- **修改目标**：查询检测参数时自动返回检测对象的 `id` 和 `name`
- **实现方式**：
  - 修改 `DetectionParam.to_dict()` 方法，默认包含检测对象信息
  - 确保查询时加载相关关联数据
  - 在响应模型中添加检测对象字段

### 2. 创建/更新时的状态检查
- **修改目标**：确保检测项目和检测对象都处于启用状态
- **实现方式**：
  - 在 `create` 和 `update` 方法中添加状态检查
  - 检查检测项目的 `status` 是否为 1
  - 检查检测项目关联的检测对象的 `status` 是否为 1
  - 失败时返回明确的错误信息

### 3. 初始化脚本更新
- **修改目标**：确保测试数据正确，支持新的修改
- **实现方式**：
  - 更新初始化脚本，移除 `material_name` 字段的使用
  - 确保检测对象和检测项目的状态设置正确

## 二、具体修改文件

### 1. `app/models/detection/detection_param.py`
- 修改 `to_dict()` 方法，默认包含检测对象信息
- 确保关联关系配置正确

### 2. `app/dal/detection_dal.py`
- 修改查询逻辑，确保加载检测项目和检测对象关联数据
- 确保 `get_paginated` 和 `search` 方法包含必要的关联加载

### 3. `app/services/detection/detection_param_service.py`
- 修改 `create` 方法，添加状态检查
- 修改 `update` 方法，添加状态检查
- 确保错误信息明确

### 4. `app/schemas/detection.py`
- 更新 `DetectionParamResponse` 模型，添加检测对象字段
- 移除 `material_name` 字段的使用

### 5. `app/routes/detection/params.py`
- 确保查询时包含检测对象信息

### 6. `script/init_all.py`
- 更新初始化脚本，移除 `material_name` 字段的使用
- 确保检测对象和检测项目的状态设置正确

## 三、测试流程

1. **删除现有数据**：运行初始化脚本，自动删除现有表和数据
2. **重新创建表**：初始化脚本自动创建最新的表结构
3. **插入测试数据**：初始化脚本插入符合新要求的测试数据
4. **验证查询结果**：检查检测参数查询是否返回检测对象信息
5. **验证创建逻辑**：测试创建检测参数时的状态检查
6. **验证更新逻辑**：测试更新检测参数时的状态检查

## 四、文档编写

编写 `后端修改说明.md`，包含：
- 修改内容概述
- API 响应结构变更
- 前端需要修改的地方
- 错误信息说明
- 测试建议

## 五、修改优先级

1. 模型和查询逻辑修改
2. 创建/更新逻辑修改
3. 响应模型修改
4. 初始化脚本更新
5. 文档编写

## 六、预期效果

- 查询检测参数时自动返回检测对象的 `id` 和 `name`
- 创建/更新检测参数时严格检查检测项目和检测对象的状态
- 提供明确的错误信息
- 测试数据符合新的业务规则
- 前端能根据文档做出相应调整