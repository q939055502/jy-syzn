# 检测规范CSV数据导入计划

## 1. 任务目标
将 `d:\Projects\jy_syzn\规范.csv` 文件中的检测规范数据导入到数据库的 `detection_standard` 表中。

## 2. 数据映射分析

### CSV文件列与数据库字段映射
| CSV列名 | 数据库字段名 | 数据类型 | 转换说明 |
|--------|-------------|----------|----------|
| 规范ID | standard_id | Integer | 直接映射 |
| 规范编号 | standard_code | String(100) | 直接映射 |
| 规范名称 | standard_name | String(255) | 直接映射 |
| 规范类型 | standard_type | String(50) | 直接映射 |
| 生效日期 | effective_time | Date | 需从字符串转换为Date类型 |
| 失效日期 | invalid_time | Date | 需从字符串转换为Date类型，空值处理 |
| 状态 | status | Integer | 直接映射（CSV中1表示有效） |
| 替代规范ID | replace_id | Integer | 直接映射，空值处理 |
| 备注 | remark | Text | 直接映射，空值处理 |
| 创建时间 | create_time | DateTime | 自动生成，无需从CSV获取 |
| 更新时间 | update_time | DateTime | 自动生成，无需从CSV获取 |

## 3. 实现方案

### 3.1 创建导入脚本
创建 `import_standards.py` 脚本，用于读取CSV文件并将数据导入到数据库中。

### 3.2 脚本主要步骤
1. **导入必要库**：
   - pandas：用于读取CSV文件
   - sqlalchemy：用于数据库连接和操作
   - 项目模型和扩展：用于数据库会话管理

2. **读取CSV文件**：
   - 使用pandas读取CSV文件
   - 处理空值和数据类型

3. **连接数据库**：
   - 使用项目已有的数据库连接配置
   - 创建数据库会话

4. **数据转换和导入**：
   - 遍历CSV数据行
   - 将每行数据转换为DetectionStandard对象
   - 处理日期格式转换
   - 处理空值
   - 使用upsert操作（存在则更新，不存在则插入）

5. **异常处理**：
   - 捕获并处理可能的异常
   - 确保数据库会话正确关闭

### 3.3 脚本代码结构
```python
# 导入必要库
import pandas as pd
from datetime import datetime
from sqlalchemy.exc import IntegrityError
from app.extensions import init_db
from app.models.detection.detection_standard import DetectionStandard
from config import config

# 主函数
def main():
    # 读取CSV文件
    # 连接数据库
    # 数据转换和导入
    # 关闭数据库连接

if __name__ == "__main__":
    main()
```

## 4. 执行流程

1. **准备工作**：
   - 确保数据库服务正在运行
   - 确保项目环境已正确配置

2. **执行脚本**：
   - 在项目根目录下运行脚本：`python import_standards.py`

3. **验证结果**：
   - 查看脚本输出，确认导入成功
   - 登录数据库，查询detection_standard表，验证数据已导入
   - 运行项目测试，确保数据导入后系统功能正常

## 5. 注意事项

1. **数据完整性**：
   - CSV文件中的"规范编号"是唯一的，导入时需确保不重复
   - 处理空值，避免数据库约束错误

2. **日期格式**：
   - CSV中的日期格式为"YYYY/MM/DD"，需转换为Python的Date类型
   - 处理空日期值

3. **事务管理**：
   - 使用数据库事务，确保数据导入的原子性
   - 如遇到错误，回滚事务，避免部分数据导入

4. **性能考虑**：
   - 对于大量数据，考虑使用批量插入
   - 本次数据量较小（60条），可逐条处理

5. **日志记录**：
   - 在脚本中添加日志记录，便于排查问题
   - 记录导入成功和失败的情况

## 6. 后续操作

1. **数据验证**：
   - 运行项目的检测规范相关测试
   - 检查API接口是否能正常返回导入的数据

2. **数据清理**：
   - 如发现导入数据有问题，可删除并重新导入
   - 或在脚本中添加数据清理逻辑

3. **文档更新**：
   - 更新项目文档，记录数据导入过程
   - 如需要，更新API文档

## 7. 预期结果

- 60条检测规范数据成功导入到数据库中
- 数据库表中没有重复数据
- 导入的数据符合数据库约束
- 项目功能正常，没有因为数据导入而出现异常

这个计划确保了检测规范数据能够安全、准确地导入到数据库中，同时考虑了各种可能的情况和异常处理。