# 1. 创建目录管理工具

## 1.1 创建工具目录和文件
- 创建 `d:\Projects\jy_syzn\app\services\detection\utils` 目录
- 添加 `file_utils.py` 文件，实现目录存在检查和创建功能

## 1.2 实现目录管理功能
- 使用 `pathlib` 库实现跨平台的目录操作
- 编写 `ensure_dir` 函数，检查目录是否存在，不存在则创建

# 2. 修改委托单模板文件上传逻辑

## 2.1 修改模板模型的 `file_path` 属性
- 更新 `app/models/detection/delegation_form_template.py` 中的 `file_path` 属性，使其生成符合要求的文件路径
- 确保路径格式为：`/static/templates/{检测项目名称}/{模板名称}{模板版本}.{文件类型}`

## 2.2 修改路由处理
- 更新 `app/routes/detection/templates.py` 中的 `create_template` 端点，使其支持文件上传
- 更新 `update_template` 端点，支持可选的文件上传
- 使用 `FastAPI` 的 `UploadFile` 和 `File` 类型处理文件上传
- 将请求类型从 `application/json` 改为 `multipart/form-data`

## 2.3 增强服务层逻辑
- 更新 `app/services/detection/delegation_form_template_service.py` 中的 `create` 方法，添加文件保存逻辑
- 更新 `update` 方法，添加文件更新和移动逻辑
- 实现以下功能：
  - 生成基于检测项目、模板名称、版本和文件扩展名的文件路径
  - 确保目录存在
  - 保存上传的文件
  - 更新时处理文件替换和移动
  - 清理旧文件

# 3. 更新 API 文档

## 3.1 修改创建模板接口文档
- 更新 `API接口说明.md` 中 `3.6.3 创建委托单模板` 部分
- 将请求类型从 `application/json` 改为 `multipart/form-data`
- 添加文件上传字段说明

## 3.2 修改更新模板接口文档
- 更新 `API接口说明.md` 中 `3.6.4 更新委托单模板` 部分
- 将请求类型从 `application/json` 改为 `multipart/form-data`
- 添加可选的文件上传字段说明

# 4. 关键技术点

## 4.1 跨平台路径处理
- 使用 `pathlib.Path` 处理文件路径，避免硬编码路径分隔符
- 确保在 Linux 和 Windows 平台上都能正常运行

## 4.2 文件上传处理
- 使用 `FastAPI` 的 `UploadFile` 处理文件上传
- 使用 `shutil.copyfileobj` 高效保存文件

## 4.3 错误处理
- 添加适当的错误处理，确保文件操作失败时返回有意义的错误信息
- 实现事务回滚，确保数据库和文件系统的一致性

# 5. 测试要点

## 5.1 创建模板测试
- 测试成功创建模板并保存文件
- 测试目录自动创建功能
- 测试不同检测项目下的文件保存

## 5.2 更新模板测试
- 测试更新模板时替换文件
- 测试更新模板元数据时移动文件
- 测试只更新元数据时的文件路径变更

## 5.3 跨平台测试
- 确保路径生成在不同平台上都能正常工作
- 测试不同文件扩展名的处理

通过以上修改，将实现符合用户需求的委托单模板文件上传功能，确保文件路径生成正确，目录自动创建，文件能够正确保存和移动，同时支持跨平台运行。